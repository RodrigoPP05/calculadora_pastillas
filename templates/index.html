<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Calculadora de Pastillas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <link rel="manifest" href="/static/manifest.json">
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#14d8dc">
    <link rel="icon" href="/static/icon-192.png">

    <script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/static/service-worker.js')
        .then(() => console.log("Service Worker registrado"));
    }
    </script>


</head>
<body>
  <div class="container">
    <h1>Calculadora de rendimiento de pastillas</h1>
    <form method="POST" class="formulario">
      <div class="campo">
        <label>Diámetro de oblea:</label>
        <input name="diametro" required>
        <select name="udiam">
          <option>cm</option><option>pulgadas</option><option>m</option><option>pies</option>
        </select>
      </div>

      <div class="campo">
        <label>Lado de pastilla:</label>
        <input name="lado" required>
        <select name="ulado">
          <option>cm</option><option>pulgadas</option><option>m</option><option>pies</option>
        </select>
      </div>

      <div class="campo">
        <label>Densidad de defectos (/cm²):</label>
        <input name="densidad" required>
      </div>

      <div class="campo">
        <label>Costo de la oblea (USD):</label>
        <input name="costo" required>
      </div>

      <button type="submit">Calcular</button>
    </form>

    {% if resultado %}
      <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'resultados')">📋 Resultados</button>
        <button class="tab-btn" onclick="openTab(event, 'grafica')">📈 Gráfica</button>
      </div>

      <div id="resultados" class="tab-content active">
        <div class="resultado">
          <h2>📋 Resultados del cálculo</h2>
          <p>Área de la oblea: {{ resultado.wafer }} cm²</p>
          <p>Área de la pastilla: {{ resultado.chip }} cm²</p>
          <p>Total de pastillas: {{ resultado.total }}</p>
          <p>Rendimiento: {{ resultado.rendimiento }} %</p>
          <p>Pastillas buenas: {{ resultado.buenas }}</p>
          <p>Costo por pastilla buena: ${{ resultado.costo }}</p>
        </div>
      </div>

      <div id="grafica" class="tab-content">
        <div id="plotly-graph"></div>
        <script>
          const data = {{ plot_data | safe }};
          const trace1 = {
            x: data.lados,
            y: data.rendimientos,
            name: 'Rendimiento (%)',
            yaxis: 'y',
            mode: 'lines+markers',
            marker: { color: 'lime' },
            line: { color: 'lime' }
            };

            const trace2 = {
            x: data.lados,
            y: data.costos,
            name: 'Costo por pastilla ($)',
            yaxis: 'y2',
            mode: 'lines+markers',
            marker: { color: 'deepskyblue' },
            line: { color: 'deepskyblue' }
            };

          const layout = {
            title: 'Rendimiento y Costo vs Lado',
            margin: { l: 60, r: 80, t: 60, b: 60 },
            xaxis: {
                title: 'Lado de pastilla (cm)',
                tickmode: 'linear',
                tick0: 0.1,
                dtick: 0.1,
                range: [0, Math.max(...data.lados)]
            },
            yaxis: {
                title: 'Rendimiento (%)',
                side: 'right',
                position: 0.95,
                overlaying: null,       // No superpone, será el eje primario
                showgrid: true,
                tickfont: { color: 'green' },
                titlefont: { color: 'green' }
            },
            yaxis2: {
                title: 'Costo ($)',
                overlaying: 'y',
                side: 'lefth',
                showgrid: false,
                tickfont: { color: 'deepskyblue' },
                titlefont: { color: 'deepskyblue' }
            },
            legend: { x: 0.1, y: 1.15, orientation: 'h' }
            };

          Plotly.newPlot('plotly-graph', [trace1, trace2], layout);
        </script>
      </div>
    {% endif %}
  </div>

  <script>
    function openTab(evt, tabName) {
      const tabcontents = document.getElementsByClassName("tab-content");
      const tabbuttons = document.getElementsByClassName("tab-btn");

      for (let i = 0; i < tabcontents.length; i++) {
        tabcontents[i].style.display = "none";
        tabcontents[i].classList.remove("active");
      }

      for (let i = 0; i < tabbuttons.length; i++) {
        tabbuttons[i].classList.remove("active");
      }

      document.getElementById(tabName).style.display = "block";
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    window.onload = function () {
      const activeTab = document.querySelector('.tab-content.active');
      if (activeTab) activeTab.style.display = "block";
    };
  </script>
</body>
</html>
<div class="tabs">
  <button class="tab-btn active" onclick="openTab(event, 'resultados')">📋 Resultados</button>
  <button class="tab-btn" onclick="openTab(event, 'grafica')">📈 Gráfica</button>
  <button class="tab-btn" onclick="openTab(event, 'historial')">📚 Historial</button>
</div>

<!-- Resultados -->
<div id="resultados" class="tab-content active">
  <div class="resultado">
    <h2>📋 Resultados del cálculo</h2>
    <p>Área de la oblea: {{ resultado.wafer }} cm²</p>
    <p>Área de la pastilla: {{ resultado.chip }} cm²</p>
    <p>Total de pastillas: {{ resultado.total }}</p>
    <p>Rendimiento: {{ resultado.rendimiento }} %</p>
    <p>Pastillas buenas: {{ resultado.buenas }}</p>
    <p>Costo por pastilla buena: ${{ resultado.costo }}</p>
  </div>
</div>

<!-- Gráfica -->
<div id="grafica" class="tab-content">
  <div id="plotly-graph"></div>
  <script>
    const data = {{ plot_data | safe }};
    const trace1 = {
      x: data.lados,
      y: data.rendimientos,
      name: 'Rendimiento (%)',
      yaxis: 'y',
      mode: 'lines+markers',
      marker: { color: 'lime' },
      line: { color: 'lime' }
    };
    const trace2 = {
      x: data.lados,
      y: data.costos,
      name: 'Costo por pastilla ($)',
      yaxis: 'y2',
      mode: 'lines+markers',
      marker: { color: 'deepskyblue' },
      line: { color: 'deepskyblue' }
    };
    const layout = {
      title: 'Rendimiento y Costo vs Lado',
      margin: { l: 60, r: 80, t: 60, b: 60 },
      xaxis: {
        title: 'Lado de pastilla (cm)',
        tickmode: 'linear',
        tick0: 0.1,
        dtick: 0.1,
        range: [0, Math.max(...data.lados)]
      },
      yaxis: {
        title: 'Rendimiento (%)',
        side: 'right',
        position: 0.95,
        showgrid: true,
        tickfont: { color: 'green' },
        titlefont: { color: 'green' }
      },
      yaxis2: {
        title: 'Costo ($)',
        overlaying: 'y',
        side: 'left',
        showgrid: false,
        tickfont: { color: 'deepskyblue' },
        titlefont: { color: 'deepskyblue' }
      },
      legend: { x: 0.1, y: 1.15, orientation: 'h' }
    };
    Plotly.newPlot('plotly-graph', [trace1, trace2], layout);
  </script>
</div>

<!-- Historial -->
<div id="historial" class="tab-content">
  <h2>📚 Historial de cálculos (sesión)</h2>
  <table id="tabla-historial">
    <thead>
      <tr>
        <th>Diámetro</th>
        <th>Lado</th>
        <th>Defectos</th>
        <th>Rendimiento (%)</th>
        <th>Costo ($)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<!-- Al final del <body> -->
<script>
  function openTab(evt, tabName) {
    const tabcontents = document.getElementsByClassName("tab-content");
    const tabbuttons = document.getElementsByClassName("tab-btn");
    for (let i = 0; i < tabcontents.length; i++) {
      tabcontents[i].style.display = "none";
      tabcontents[i].classList.remove("active");
    }
    for (let i = 0; i < tabbuttons.length; i++) {
      tabbuttons[i].classList.remove("active");
    }
    document.getElementById(tabName).style.display = "block";
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
  }

  function guardarEnHistorial(d, l, dens, rend, cost) {
    const nuevo = { d, l, dens, rend, cost };
    const historial = JSON.parse(sessionStorage.getItem('historial')) || [];
    historial.push(nuevo);
    sessionStorage.setItem('historial', JSON.stringify(historial));
    mostrarHistorial();
  }

  function mostrarHistorial() {
    const historial = JSON.parse(sessionStorage.getItem('historial')) || [];
    const tbody = document.querySelector("#tabla-historial tbody");
    tbody.innerHTML = "";
    historial.forEach(item => {
      const fila = `<tr>
        <td>${item.d}</td>
        <td>${item.l}</td>
        <td>${item.dens}</td>
        <td>${item.rend}</td>
        <td>${item.cost}</td>
      </tr>`;
      tbody.innerHTML += fila;
    });
  }

  window.onload = function () {
    const activeTab = document.querySelector('.tab-content.active');
    if (activeTab) activeTab.style.display = "block";
    mostrarHistorial();
  };
</script>

<!-- Inyectar datos cuando hay resultado -->
{% if resultado %}
<script>
  guardarEnHistorial(
    "{{ request.form['diametro'] }}",
    "{{ request.form['lado'] }}",
    "{{ request.form['densidad'] }}",
    "{{ resultado.rendimiento }}",
    "{{ resultado.costo }}"
  );
</script>
{% endif %}
