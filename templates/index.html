<!DOCTYPE html>
<html lang="es">
<head>
  <!-- Codificación de caracteres y título -->
  <meta charset="UTF-8">
  <title>Calculadora de Pastillas</title>

  <!-- Enlace a la hoja de estilos -->
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- Librería Plotly para gráficas interactivas -->
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

  <!-- Color del navegador en móviles -->
  <meta name="theme-color" content="#14d8dc">

  <!-- Ícono del sitio -->
  <link rel="icon" href="/static/icon-192.png">

  <!-- Registro del service worker para modo offline -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(() => console.log("Service Worker registrado"));
    }
  </script>
</head>

<body>
  <div class="container">
    <h1>Calculadora de rendimiento de pastillas</h1>

    <!-- FORMULARIO PRINCIPAL -->
    <form method="POST" class="formulario">

      <!-- Diámetro de la oblea con selector de unidad -->
      <div class="campo">
        <label>Diámetro de oblea:</label>
        <input name="diametro" required>
        <select name="udiam">
          <option>cm</option><option>pulgadas</option><option>m</option><option>pies</option>
        </select>
      </div>

      <!-- Lado de la pastilla con selector de unidad -->
      <div class="campo">
        <label>Lado de pastilla:</label>
        <input name="lado" required>
        <select name="ulado">
          <option>cm</option><option>pulgadas</option><option>m</option><option>pies</option>
        </select>
      </div>

      <!-- Densidad de defectos por centímetro cuadrado -->
      <div class="campo">
        <label>Densidad de defectos (/cm²):</label>
        <input name="densidad" required>
      </div>

      <!-- Costo de la oblea -->
      <div class="campo">
        <label>Costo de la oblea (USD):</label>
        <input name="costo" required>
      </div>

      <!-- Rendimiento de la oblea, opcional -->
      <div class="campo">
        <label>Rendimiento por Oblea (%):</label>
        <input name="Rendimiento Por Oblea" type="number" placeholder="100" min="0" max="100">
      </div>

      <!-- Opción para activar el cálculo del circuito integrado -->
      <div class="campo">
        <label>
          <input type="checkbox" id="usar_extra" name="usar_extra" onchange="mostrarCamposExtras()"> Calcular con datos del circuito integrado (opcional)
        </label>
      </div>

      <!-- CAMPOS ADICIONALES PARA CIRCUITO INTEGRADO -->
      <div id="extra_fields" style="display: none;">
        <div class="campo">
          <label>Costo de prueba por pastilla (USD):</label>
          <input name="costo_prueba" type="number" step="0.01" min="0">
        </div>
        <div class="campo">
          <label>Costo de empaquetado por pastilla (USD):</label>
          <input name="costo_empaque" type="number" step="0.01" min="0">
        </div>
        <div class="campo">
          <label>Rendimiento de prueba final (%):</label>
          <input name="rend_final" type="number" placeholder="100" min="0" max="100">
        </div>
      </div>

      <!-- Botón de envío del formulario -->
      <button type="submit">Calcular</button>
    </form>
      <!-- Botones de navegación entre pestañas -->
      <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'resultados')">📋 Resultados</button>
        <button class="tab-btn" onclick="openTab(event, 'grafica')">📈 Gráfica</button>
        <button class="tab-btn" onclick="openTab(event, 'historial')">📚 Historial</button>
        <button class="tab-btn" onclick="openTab(event, 'ejercicio')">🧠 Modo Ejercicio</button>
      </div>
    
    <!-- MOSTRAR RESULTADOS SI EXISTEN -->
    {% if resultado %}

      <!-- Pestaña de resultados numéricos -->
      <div id="resultados" class="tab-content active">
        <h2>📋 Resultados del cálculo</h2>
        <p>Área de la oblea: {{ resultado.wafer }} cm²</p>
        <p>Área de la pastilla: {{ resultado.chip }} cm²</p>
        <p>Total de pastillas: {{ resultado.total }}</p>
        <p>Rendimiento: {{ resultado.rendimiento }} %</p>
        <p>Pastillas buenas: {{ resultado.buenas }}</p>
        <p>Costo por pastilla buena: ${{ resultado.costo }}</p>
        {% if resultado.costo_ic %}
          <p>🧠 Costo del circuito integrado: ${{ resultado.costo_ic }}</p>
        {% endif %}
      </div>

      <!-- Gráfica Plotly de rendimiento y costo -->
      <div id="grafica" class="tab-content">
        <div id="plotly-graph"></div>
        <script>
          const data = {{ plot_data | safe }};
          Plotly.newPlot('plotly-graph', [
            {
              x: data.lados,
              y: data.rendimientos,
              name: 'Rendimiento (%)',
              yaxis: 'y',
              mode: 'lines+markers',
              marker: { color: 'lime' },
              line: { color: 'lime' }
            },
            {
              x: data.lados,
              y: data.costos,
              name: 'Costo por pastilla ($)',
              yaxis: 'y2',
              mode: 'lines+markers',
              marker: { color: 'deepskyblue' },
              line: { color: 'deepskyblue' }
            }
          ], {
            title: 'Rendimiento y Costo vs Lado',
            xaxis: { title: 'Lado de pastilla (cm)' },
            yaxis: {
              title: 'Rendimiento (%)',
              tickfont: { color: 'lime' },
              titlefont: { color: 'lime' }
            },
            yaxis2: {
              title: 'Costo ($)',
              overlaying: 'y',
              side: 'right',
              tickfont: { color: 'deepskyblue' },
              titlefont: { color: 'deepskyblue' }
            }
          });
        </script>
      </div>
    {% endif %}

    <!-- Tabla con historial de cálculos realizados (guardado en sesión local del navegador) -->
    <div id="historial" class="tab-content {% if not resultado %}active{% endif %}">
      <h2>📚 Historial de cálculos (sesión)</h2>
      <table id="tabla-historial">
        <thead>
          <tr>
            <th>Diámetro</th>
            <th>Lado</th>
            <th>Defectos</th>
            <th>Rendimiento (%)</th>
            <th>Costo ($)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- Modo educativo con ejercicios teóricos -->
    <div id="ejercicio" class="tab-content">
      <h2>🧠 Modo Ejercicio Teórico</h2>
      <p>Selecciona el tipo de cálculo:</p>
      <div class="campo">
        <label for="tipo_calculo">Tipo de cálculo:</label>
        <select id="tipo_calculo" onchange="mostrarOpcionesEjercicio()">
          <option value="">-- Selecciona --</option>
          <option value="pastilla">Costo por pastilla</option>
          <option value="oblea_para_precio">Costo de oblea deseado</option>
          <option value="ic">Costo circuito integrado</option>
          <option value="comparacion">Comparación de costos</option>
        </select>
      </div>
      <div id="formulario_ejercicio"></div>
      <div id="resultado_ejercicio" style="margin-top: 15px;"></div>
    </div>
  </div>

  <!-- SCRIPT FUNCIONAL DE INTERFAZ -->
  <script>
    // Cambia entre pestañas
    function openTab(evt, tabName) {
      const tabs = document.getElementsByClassName("tab-content");
      const buttons = document.getElementsByClassName("tab-btn");
      for (let t of tabs) t.classList.remove("active");
      for (let b of buttons) b.classList.remove("active");
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    // Muestra u oculta los campos del circuito integrado
    function mostrarCamposExtras() {
      const check = document.getElementById('usar_extra');
      document.getElementById('extra_fields').style.display = check.checked ? 'block' : 'none';
    }

    // Muestra el historial guardado en sessionStorage
    function mostrarHistorial() {
      const hist = JSON.parse(sessionStorage.getItem('historial')) || [];
      const tbody = document.querySelector("#tabla-historial tbody");
      tbody.innerHTML = "";
      hist.forEach(item => {
        tbody.innerHTML += `<tr>
          <td>${item.d}</td>
          <td>${item.l}</td>
          <td>${item.dens}</td>
          <td>${item.rend}</td>
          <td>${item.cost}</td>
        </tr>`;
      });
    }

    // Carga el formulario según el tipo de ejercicio teórico seleccionado
    function mostrarOpcionesEjercicio() {
      const tipo = document.getElementById('tipo_calculo').value;
      const form = document.getElementById('formulario_ejercicio');
      const res = document.getElementById('resultado_ejercicio');
      res.innerHTML = "";
      if (tipo === "pastilla") {
        form.innerHTML = `...`;
      } else if (tipo === "oblea_para_precio") {
        form.innerHTML = `...`;
      } else if (tipo === "ic") {
        form.innerHTML = `...`;
      } else if (tipo === "comparacion") {
        form.innerHTML = `...`;
      } else {
        form.innerHTML = "";
      }
    }

    // Cálculos para el modo educativo
    function calcularPastilla() { ... }
    function calcularObleaDesdePrecio() { ... }
    function calcularIC() { ... }
    function compararCostos() { ... }

    // Ejecutar funciones al cargar la página
    window.onload = function () {
      mostrarCamposExtras();
      mostrarHistorial();
    };
  </script>
</body>
</html>
