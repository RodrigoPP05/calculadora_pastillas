<!DOCTYPE html>
<html lang="es">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta charset="UTF-8">
  <title>Calculadora de Pastillas</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="manifest" href="/static/manifest.json"/>
  <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <meta name="theme-color" content="#14d8dc">
  <style>
    #graficoChart-container {
      position: relative;
      width: 100%;
      height: 400px;
    }
    canvas#graficoChart {
      width: 100% !important;
      height: 100% !important;
    }

    /* AnimaciÃ³n para el splash */
    #custom-splash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: #0a0a0a;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.8s ease;
    }
    #custom-splash .spinner {
      width: 40px;
      height: 40px;
      border: 5px solid #14d8dc;
      border-top: 5px solid transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #custom-splash p {
      color: white;
      font-size: 1.2rem;
      text-align: center;
    }
  </style>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/static/service-worker.js')
        .then(() => console.log("Service Worker registrado"));
    }
  </script>
</head>

<body>
  <!-- Pantalla de carga animada -->
  <div id="custom-splash">
    <div class="spinner"></div>
    <p>Iniciando Calculadora...</p>
  </div>

  <!-- Contenido principal -->
  <div class="container">
    <h1>Calculadora de rendimiento de pastillas</h1>

    <!-- Tu formulario y pestaÃ±as quedan sin cambios -->
    {% block content %}
      {{ super() }}
    {% endblock %}
  </div>

  <!-- JavaScript funcional -->
  <script>
    function openTab(evt, tabName) {
      const tabs = document.getElementsByClassName("tab-content");
      const buttons = document.getElementsByClassName("tab-btn");
      for (let t of tabs) t.classList.remove("active");
      for (let b of buttons) b.classList.remove("active");
      document.getElementById(tabName).classList.add("active");
      evt.currentTarget.classList.add("active");
    }

    function mostrarCamposExtras() {
      const check = document.getElementById('usar_extra');
      document.getElementById('extra_fields').style.display = check.checked ? 'block' : 'none';
    }

    function mostrarHistorial() {
      const hist = JSON.parse(sessionStorage.getItem('historial')) || [];
      const tbody = document.querySelector("#tabla-historial tbody");
      tbody.innerHTML = "";
      hist.forEach(item => {
        tbody.innerHTML += `
          <tr>
            <td>${item.d}</td>
            <td>${item.l}</td>
            <td>${item.dens}</td>
            <td>${item.rend}</td>
            <td>${item.cost}</td>
          </tr>
        `;
      });
    }

    function mostrarOpcionesEjercicio() {
      const tipo = document.getElementById('tipo_calculo').value;
      const form = document.getElementById('formulario_ejercicio');
      const res = document.getElementById('resultado_ejercicio');
      res.innerHTML = "";
      if (tipo === "pastilla") {
        form.innerHTML = `
          <div class="campo"><label>Costo oblea ($):</label><input id="oblea_cost"></div>
          <div class="campo"><label>Pastillas:</label><input id="num_pastillas"></div>
          <div class="campo"><label>Rendimiento (%):</label><input id="rendimiento"></div>
          <button onclick="calcularPastilla()">Calcular</button>`;
      } else if (tipo === "oblea_para_precio") {
        form.innerHTML = `
          <div class="campo"><label>Precio objetivo ($):</label><input id="precio_objetivo"></div>
          <div class="campo"><label>Pastillas:</label><input id="num_pastillas"></div>
          <div class="campo"><label>Rendimiento (%):</label><input id="rendimiento"></div>
          <button onclick="calcularObleaDesdePrecio()">Calcular</button>`;
      } else if (tipo === "ic") {
        form.innerHTML = `
          <div class="campo"><label>Pastilla ($):</label><input id="pastilla"></div>
          <div class="campo"><label>Prueba ($):</label><input id="prueba"></div>
          <div class="campo"><label>Empaque ($):</label><input id="empaque"></div>
          <div class="campo"><label>Rendimiento final (%):</label><input id="rend_final"></div>
          <button onclick="calcularIC()">Calcular</button>`;
      } else if (tipo === "comparacion") {
        form.innerHTML = `
          <div class="campo"><label>Precio original ($):</label><input id="original"></div>
          <div class="campo"><label>Precio nuevo ($):</label><input id="nuevo"></div>
          <div class="campo"><label>Prueba ($):</label><input id="prueba"></div>
          <div class="campo"><label>Empaque ($):</label><input id="empaque"></div>
          <div class="campo"><label>Rendimiento final (%):</label><input id="rend_final"></div>
          <button onclick="compararCostos()">Calcular</button>`;
      } else {
        form.innerHTML = "";
      }
    }

    function calcularPastilla() {
      const c = parseFloat(document.getElementById('oblea_cost').value);
      const n = parseFloat(document.getElementById('num_pastillas').value);
      const y = parseFloat(document.getElementById('rendimiento').value) / 100;
      document.getElementById('resultado_ejercicio').innerHTML = `<p>ðŸ”¹ Costo por pastilla: $${(c / (n * y)).toFixed(2)}</p>`;
    }

    function calcularObleaDesdePrecio() {
      const p = parseFloat(document.getElementById('precio_objetivo').value);
      const n = parseFloat(document.getElementById('num_pastillas').value);
      const y = parseFloat(document.getElementById('rendimiento').value) / 100;
      document.getElementById('resultado_ejercicio').innerHTML = `<p>ðŸ”¹ Costo necesario de oblea: $${(p * n * y).toFixed(2)}</p>`;
    }

    function calcularIC() {
      const d = parseFloat(document.getElementById('pastilla').value);
      const t = parseFloat(document.getElementById('prueba').value);
      const p = parseFloat(document.getElementById('empaque').value);
      const y = parseFloat(document.getElementById('rend_final').value) / 100;
      document.getElementById('resultado_ejercicio').innerHTML = `<p>ðŸ”¹ Costo del IC: $${((d + t + p) / y).toFixed(2)}</p>`;
    }

    function compararCostos() {
      const d1 = parseFloat(document.getElementById('original').value);
      const d2 = parseFloat(document.getElementById('nuevo').value);
      const t = parseFloat(document.getElementById('prueba').value);
      const p = parseFloat(document.getElementById('empaque').value);
      const y = parseFloat(document.getElementById('rend_final').value) / 100;
      const c1 = (d1 + t + p) / y;
      const c2 = (d2 + t + p) / y;
      const factor = c2 / c1;
      document.getElementById('resultado_ejercicio').innerHTML = `
        <p>ðŸ”¹ Costo anterior del IC: $${c1.toFixed(2)}</p>
        <p>ðŸ”¹ Costo nuevo del IC: $${c2.toFixed(2)}</p>
        <p>ðŸ”¹ Incremento: ${factor.toFixed(2)} veces</p>`;
    }

    {% if resultado %}
    const nuevo = {
      d: "{{ request.form['diametro'] }} {{ request.form['udiam'] }}",
      l: "{{ request.form['lado'] }} {{ request.form['ulado'] }}",
      dens: "{{ request.form['densidad'] }}",
      rend: "{{ resultado.rendimiento }}",
      cost: "{{ resultado.costo }}"
    };

    let historial = JSON.parse(sessionStorage.getItem('historial')) || [];

    if (!historial.some(h =>
      h.d === nuevo.d &&
      h.l === nuevo.l &&
      h.dens === nuevo.dens &&
      h.rend === nuevo.rend &&
      h.cost === nuevo.cost
    )) {
      historial.push(nuevo);
      sessionStorage.setItem('historial', JSON.stringify(historial));
    }
    {% endif %}

    // AnimaciÃ³n splash screen
    window.addEventListener('DOMContentLoaded', () => {
      const splash = document.getElementById('custom-splash');
      if (splash) {
        setTimeout(() => {
          splash.style.opacity = '0';
          splash.addEventListener('transitionend', () => {
            splash.style.display = 'none';
          });
        }, 1500);
      }
    });

    window.onload = function () {
      mostrarCamposExtras();
      mostrarHistorial();
    };
  </script>
</body>
</html>
